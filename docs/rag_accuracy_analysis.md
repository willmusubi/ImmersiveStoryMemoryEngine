# RAG 查询准确性分析

## 问题描述

查询"诸葛孔明，草庐"时，返回的结果虽然包含"孔明"，但没有找到关于"草庐"（三顾茅庐）的相关内容。

## 可能的原因

### 1. Embedding 模型对古文的理解

**问题**：
- `text-embedding-3-small` 可能对古文（文言文）的语义理解不够准确
- 古文和白话文的表达方式差异较大，embedding 可能无法很好地建立语义关联

**证据**：
- 查询"诸葛孔明，草庐"返回的结果包含"孔明"但不包含"草庐"
- 说明模型能识别"孔明"这个关键词，但对"草庐"的语义理解可能不够

### 2. 查询文本不够明确

**问题**：
- "诸葛孔明，草庐" 这种逗号分隔的查询可能不够明确
- 模型可能将其理解为两个独立的概念，而不是"诸葛亮的草庐"

**建议**：
- 使用更明确的查询："三顾茅庐"、"诸葛亮草庐"、"孔明隆中"
- 或者使用完整句子："诸葛亮在哪里隐居？"

### 3. 索引内容问题

**可能情况**：
- 原始文件中确实包含"草庐"相关内容，但可能：
  - 被分割到不同的 chunks 中
  - 文本预览（text_preview）只显示前200字符，可能没有包含关键词
  - Chunk 太小被丢弃（已修复）

### 4. 关键词匹配不够精确

**问题**：
- 混合检索的关键词匹配可能对古文不够敏感
- 古文中的同义词、异体字可能无法匹配

## 解决方案

### 方案 1: 使用白话文版本（推荐）

**优点**：
- 白话文更容易被 embedding 模型理解
- 语义关联更准确
- 查询结果更相关

**实施**：
1. 准备白话文版本的《三国演义》
2. 重新创建索引
3. 测试查询准确性

### 方案 2: 优化查询方式

**建议**：
1. **使用更明确的查询**：
   - ❌ "诸葛孔明，草庐"
   - ✅ "三顾茅庐"
   - ✅ "诸葛亮草庐"
   - ✅ "孔明隆中隐居"

2. **使用完整句子**：
   - ❌ "诸葛孔明，草庐"
   - ✅ "诸葛亮的草庐在哪里？"
   - ✅ "三顾茅庐的故事"

### 方案 3: 改进索引策略

1. **增加文本预览长度**：
   - 当前：200 字符
   - 建议：500-1000 字符（确保包含更多上下文）

2. **改进 chunking 策略**：
   - 按语义段落分割，而不是固定长度
   - 保留更多上下文信息

3. **添加元数据**：
   - 提取关键实体（人物、地点、事件）
   - 在索引时添加标签，便于后续过滤

### 方案 4: 使用更适合中文的 Embedding 模型

**如果 API 支持**：
- 尝试 `text-embedding-3-large`（更大的模型，可能对中文理解更好）
- 或者使用专门的中文 embedding 模型

### 方案 5: 混合检索优化

1. **增强关键词匹配**：
   - 添加同义词词典（草庐=茅庐=隆中）
   - 支持模糊匹配

2. **提高关键词权重**：
   - 如果查询中包含的关键词在结果中出现，大幅提高排名

## 测试建议

### 测试 1: 检查索引内容

```python
import json

# 检查索引中是否包含"草庐"
meta_path = 'data/indices/sanguo_test_world_bible_meta.jsonl'
with open(meta_path, 'r', encoding='utf-8') as f:
    for line in f:
        meta = json.loads(line)
        if '草庐' in meta.get('text_preview', ''):
            print(f"找到: {meta['chunk_id']}")
            print(f"预览: {meta['text_preview']}")
```

### 测试 2: 测试不同查询

```python
from backend.rag import RAGService

rag = RAGService()
queries = [
    "三顾茅庐",
    "诸葛亮草庐",
    "孔明隆中",
    "诸葛亮的隐居地",
]

for query in queries:
    results = rag.query('sanguo_test', query, top_k=5)
    # 检查结果相关性
```

### 测试 3: 对比古文和白话文

如果准备白话文版本，可以：
1. 创建两个索引（古文版和白话文版）
2. 使用相同的查询测试
3. 对比结果准确性

## 结论

**主要原因**：Embedding 模型对古文的理解可能不够准确，导致语义关联不够强。

**最佳解决方案**：
1. **短期**：使用更明确的查询方式（如"三顾茅庐"）
2. **长期**：使用白话文版本重新创建索引

**其他优化**：
- 增加文本预览长度
- 改进关键词匹配
- 考虑使用更适合中文的 embedding 模型

